# test_auto_population.py
"""
Test that new fields are automatically populated
"""

import sys
sys.path.append('C:\\Users\\lanee\\Desktop\\whatspoppingABQ')

from database.db_utils import get_connection, insert_traffic_measurement
from datetime import datetime

print("=" * 70)
print("Test Auto-Population of New Fields")
print("=" * 70)
print()

# Setup: Get or create test event
print("Setting up test data...")
print("-" * 70)

conn = get_connection()
try:
    with conn.cursor() as cur:
        # Get any real event
        cur.execute("""
            SELECT event_id, event_name 
            FROM events 
            WHERE event_start_time IS NOT NULL 
            LIMIT 1
        """)
        
        result = cur.fetchone()
        
        if result:
            test_event_id = result[0]
            test_event_name = result[1]
            print(f"✓ Using existing event: ID={test_event_id}, '{test_event_name}'")
        else:
            print("⚠ No events found - creating test event")
            
            # Get a venue
            cur.execute("SELECT venue_id FROM venue_locations LIMIT 1")
            venue_result = cur.fetchone()
            
            if not venue_result:
                print("❌ No venues found! Run geocoding first.")
                exit(1)
            
            venue_id = venue_result[0]
            
            # Create test event
            cur.execute("""
                INSERT INTO events (
                    event_name, 
                    venue_id, 
                    event_start_date, 
                    event_end_date,
                    event_start_time,
                    category
                ) VALUES (
                    'TEST - Auto Population Test',
                    %s,
                    CURRENT_DATE,
                    CURRENT_DATE,
                    '18:00:00',
                    'Test'
                )
                RETURNING event_id
            """, (venue_id,))
            
            test_event_id = cur.fetchone()[0]
            conn.commit()
            print(f"✓ Created test event: ID={test_event_id}")

finally:
    conn.close()

print()
# Test 1: Event traffic (with event_id)
print("Test 1: Event Traffic Measurement")
print("-" * 70)

test_event_traffic = {
    'traffic_level': 'moderate',
    'avg_speed_mph': 25.5,
    'typical_speed_mph': 30.0,
    'travel_time_seconds': 300,
    'typical_time_seconds': 240,
    'delay_minutes': 1.5,
    'data_source': 'google_maps',
    'origin_lat': 35.0781,
    'origin_lng': -106.6044,
    'destination_lat': 35.0881,
    'destination_lng': -106.6044,
    'distance_miles': 1.0,
    'is_baseline': False,
    'raw_response': '{"test": true}'
}

try:
    # Use Feb 13, 2026 (which is a Friday)
    test_time = datetime(2026, 2, 13, 18, 30)
    
    measurement_id = insert_traffic_measurement(
        venue_id=1,
        measurement_time=test_time,
        traffic_data=test_event_traffic,
        event_id=test_event_id
    )
    
    print(f"✓ Created measurement ID: {measurement_id}")
    
    # Verify it was populated correctly
    conn = get_connection()
    try:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT 
                    event_id,
                    is_baseline,
                    baseline_type,
                    day_of_week,
                    hour_of_day,
                    measurement_time
                FROM traffic_measurements
                WHERE measurement_id = %s
            """, (measurement_id,))
            
            row = cur.fetchone()
            event_id, is_baseline, baseline_type, dow, hour, meas_time = row
            
            # Feb 13, 2026 is Friday
            # Python: Friday = 4
            # PostgreSQL: Friday = 5 (Sunday=0, Monday=1, ..., Friday=5, Saturday=6)
            expected_dow = 5
            
            print(f"  event_id: {event_id} (expected: {test_event_id})")
            print(f"  is_baseline: {is_baseline} (expected: False)")
            print(f"  baseline_type: {baseline_type} (expected: None)")
            print(f"  day_of_week: {dow} (expected: {expected_dow} for Friday)")
            print(f"  hour_of_day: {hour} (expected: 18)")
            print(f"  measurement_time: {meas_time}")
            
            # Validate
            assert event_id == test_event_id, f"event_id mismatch!"
            assert is_baseline == False, "is_baseline not False!"
            assert baseline_type is None, "baseline_type should be None!"
            assert dow == expected_dow, f"day_of_week should be {expected_dow} (Friday), got {dow}!"
            assert hour == 18, f"hour_of_day should be 18, got {hour}!"
            
            print()
            print("✓ All fields populated correctly!")
    except Exception as e:
        print(f"✗ Error: {e}")
    import traceback
    traceback.print_exc()            
finally:
    conn.close()

# Test 2: Baseline traffic (no event_id)
print("Test 2: Baseline Traffic Measurement")
print("-" * 70)

test_baseline_traffic = {
    'traffic_level': 'light',
    'avg_speed_mph': 32.0,
    'typical_speed_mph': 35.0,
    'travel_time_seconds': 220,
    'typical_time_seconds': 200,
    'delay_minutes': 0.3,
    'data_source': 'tomtom',
    'origin_lat': 35.0781,
    'origin_lng': -106.6044,
    'destination_lat': 35.0881,
    'destination_lng': -106.6044,
    'distance_miles': 1.0,
    'is_baseline': True,
    'baseline_type': 'weekly',
    'raw_response': '{"test": true}'
}

try:
    measurement_id = insert_traffic_measurement(
        venue_id=1,
        measurement_time=datetime(2026, 2, 14, 12, 0),  # Saturday 12:00 PM
        traffic_data=test_baseline_traffic,
        event_id=None  # No event for baseline
    )
    
    print(f"✓ Created measurement ID: {measurement_id}")
    
    # Verify
    conn = get_connection()
    try:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT 
                    event_id,
                    is_baseline,
                    baseline_type,
                    day_of_week,
                    hour_of_day
                FROM traffic_measurements
                WHERE measurement_id = %s
            """, (measurement_id,))
            
            row = cur.fetchone()
            event_id, is_baseline, baseline_type, dow, hour = row
            
            print(f"  event_id: {event_id} (expected: None)")
            print(f"  is_baseline: {is_baseline} (expected: True)")
            print(f"  baseline_type: {baseline_type} (expected: 'weekly')")
            print(f"  day_of_week: {dow} (expected: 6 for Saturday)")
            print(f"  hour_of_day: {hour} (expected: 12)")
            
            # Validate
            assert event_id is None, "event_id should be None!"
            assert is_baseline == True, "is_baseline should be True!"
            assert baseline_type == 'weekly', f"baseline_type should be 'weekly', got {baseline_type}!"
            assert dow == 6, f"day_of_week should be 6, got {dow}!"
            assert hour == 12, f"hour_of_day should be 12, got {hour}!"
            
            print()
            print("✓ All fields populated correctly!")
            
    finally:
        conn.close()
        
except Exception as e:
    print(f"✗ Error: {e}")
    import traceback
    traceback.print_exc()

print()
print("=" * 70)
print("Auto-Population Tests Complete!")
print("=" * 70)