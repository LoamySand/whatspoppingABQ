# test_google_maps_api.py
"""
Test Google Maps API setup and key restrictions
"""

import os
from dotenv import load_dotenv
import googlemaps
from datetime import datetime

# Load environment variables
load_dotenv()

# Get API key
api_key = os.getenv('GOOGLE_MAPS_API_KEY')

if not api_key:
    print("❌ ERROR: GOOGLE_MAPS_API_KEY not found in .env file")
    exit(1)

print("=" * 70)
print("Google Maps API Test")
print("=" * 70)
print()

# Initialize client
try:
    gmaps = googlemaps.Client(key=api_key)
    print("✓ API client initialized")
except Exception as e:
    print(f"❌ Failed to initialize client: {e}")
    exit(1)

print()

# Test 1: Geocoding
print("Test 1: Geocoding API")
print("-" * 70)
try:
    geocode_result = gmaps.geocode('Isotopes Park, Albuquerque, NM')
    
    if geocode_result:
        location = geocode_result[0]['geometry']['location']
        address = geocode_result[0]['formatted_address']
        
        print(f"✓ Geocoding successful!")
        print(f"  Address: {address}")
        print(f"  Coordinates: ({location['lat']}, {location['lng']})")
    else:
        print("❌ No results found")
        
except Exception as e:
    print(f"❌ Geocoding failed: {e}")

print()

# Test 2: Distance Matrix (for traffic data)
print("Test 2: Distance Matrix API (Traffic)")
print("-" * 70)
try:
    # Test traffic between two Albuquerque locations
    origins = ["Isotopes Park, Albuquerque, NM"]
    destinations = ["University Arena, Albuquerque, NM"]
    
    # Request with traffic model
    result = gmaps.distance_matrix(
        origins=origins,
        destinations=destinations,
        mode="driving",
        departure_time=datetime.now(),
        traffic_model="best_guess"
    )
    
    if result['status'] == 'OK':
        element = result['rows'][0]['elements'][0]
        
        if element['status'] == 'OK':
            distance = element['distance']['text']
            duration = element['duration']['text']
            duration_in_traffic = element.get('duration_in_traffic', {}).get('text', 'N/A')
            
            print("✓ Distance Matrix successful!")
            print(f"  Distance: {distance}")
            print(f"  Duration (no traffic): {duration}")
            print(f"  Duration (with traffic): {duration_in_traffic}")
        else:
            print(f"❌ Element status: {element['status']}")
    else:
        print(f"❌ API status: {result['status']}")
        
except Exception as e:
    print(f"❌ Distance Matrix failed: {e}")

print()

# Test 3: Check API usage limits
print("Test 3: API Info")
print("-" * 70)
print(f"✓ API Key: {api_key[:20]}... (hidden)")
print(f"✓ API restrictions: Check Google Cloud Console")
print()

print("=" * 70)
print("API Setup Complete!")
print("=" * 70)
print()
print("Next steps:")
print("  1. Check Google Cloud Console for API usage")
print("  2. Monitor free tier credits ($200/month)")
print("  3. Set up billing alerts (recommended)")
print()