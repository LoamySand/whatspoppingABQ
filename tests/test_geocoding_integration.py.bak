"""
Test that geocoding integrates with the pipeline
"""

import sys
sys.path.append('C:\\Users\\lanee\\Desktop\\whatspoppingABQ')

from database.db_utils import geocode_and_link_events, get_connection

print("=" * 70)
print("Geocoding Integration Test")
print("=" * 70)
print()

# Check events without venue_id
conn = get_connection()

try:
    with conn.cursor() as cur:
        cur.execute("""
            SELECT COUNT(*) 
            FROM events 
            WHERE venue_id IS NULL
        """)
        
        unlinked = cur.fetchone()[0]
        
        print(f"Events without venue_id: {unlinked}")
        
        if unlinked > 0:
            cur.execute("""
                SELECT DISTINCT venue_name 
                FROM events 
                WHERE venue_id IS NULL
                LIMIT 5
            """)
            
            print("\nSample venues needing geocoding:")
            for row in cur.fetchall():
                print(f"  - {row[0]}")
finally:
    conn.close()

print()
print("Running geocoding...")
print("-" * 70)

geocoded = geocode_and_link_events()

print()
print(f"âœ“ Geocoded {geocoded} venues")

# Verify
conn = get_connection()

try:
    with conn.cursor() as cur:
        cur.execute("""
            SELECT COUNT(*) 
            FROM events 
            WHERE venue_id IS NULL
        """)
        
        still_unlinked = cur.fetchone()[0]
        
        print(f"Events still without venue_id: {still_unlinked}")
        
        cur.execute("""
            SELECT COUNT(*) 
            FROM events 
            WHERE venue_id IS NOT NULL
        """)
        
        linked = cur.fetchone()[0]
        
        print(f"Events with venue_id: {linked}")
finally:
    conn.close()

print()
print("=" * 70)
print("Test Complete!")
print("=" * 70)