# test_enhanced_pipeline.py
"""
Test enhanced pipeline: scrape with details → load to database
"""

import sys
sys.path.append('C:\\Users\\lanee\\Desktop\\whatspoppingABQ')

from scrapers.visit_abq_detail_scraper import scrape_events_with_details, validate_event
from database.db_utils import insert_events, get_event_statistics

print("=" * 70)
print("Enhanced Pipeline Test")
print("=" * 70)
print()

print("This will scrape 1 page with detailed event information")
print("Then load it into the database with new schema")
print()

# Scrape
print("Step 1: Scraping events...")
print("-" * 70)

events = scrape_events_with_details(max_pages=1)

print(f"✓ Scraped {len(events)} events")
print()

# Validate
print("Step 2: Validating events...")
print("-" * 70)

valid_events = []
for event in events:
    is_valid, msg = validate_event(event)
    if is_valid:
        valid_events.append(event)
    else:
        print(f"  ✗ Invalid: {event.get('event_name')} - {msg}")

print(f"✓ Valid events: {len(valid_events)}/{len(events)}")
print()

# Show sample
if valid_events:
    print("Sample event:")
    print("-" * 70)
    sample = valid_events[0]
    for key, value in sample.items():
        if value is not None:
            print(f"  {key}: {value}")
    print()

# Load to database
print("Step 3: Loading to database...")
print("-" * 70)

try:
    count = insert_events(valid_events)
    print(f"✓ Loaded {count} events")
except Exception as e:
    print(f"✗ Error: {e}")
    exit(1)

print()

# Get statistics
print("Step 4: Database Statistics")
print("-" * 70)

stats = get_event_statistics()

print(f"Total events: {stats['total_events']}")
print(f"Multi-day events: {stats['multi_day_events']} ({stats['multi_day_events']*100//stats['total_events']}%)")
print(f"Events with times: {stats['events_with_times']} ({stats['events_with_times']*100//stats['total_events']}%)")
print(f"Events with cost: {stats['events_with_cost']} ({stats['events_with_cost']*100//stats['total_events']}%)")
print(f"Free events: {stats['free_events']}")
print(f"Events with sponsors: {stats['events_with_sponsors']} ({stats['events_with_sponsors']*100//stats['total_events']}%)")

print()
print("=" * 70)
print("Enhanced Pipeline Test Complete!")
print("=" * 70)